{% load static tailwind_tags %}
{% tailwind_css %}

{% load static %}
{% include 'fragments/messages.html' %}
{% include 'fragments/form_errors.html' %}
{% include 'fragments/search_table_ajax.html' %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts: Inter & Outfit -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Font Awesome 5.15.4 sin integrity para evitar bloqueo y asegurar visibilidad de iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!--

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-health': '#10b981',
                        'secondary-vision': '#3b82f6',
                        'accent-eye': '#6366f1',
                        'warning-fatigue': '#f59e0b',
                        'danger-alert': '#ef4444',
                        'gold': {
                            premium: '#ffd700',
                            light: '#ffe066',
                            bg: '#fffbe7',
                            hover: '#fff7b2',
                            soft: '#e6c97a'
                        },
                        aurora: {
                            1: '#6366f1',
                            2: '#22d3ee',
                            3: '#fbbf24'
                        }
                    },
                    backgroundImage: {
                        'premium-gradient': 'linear-gradient(120deg, var(--aurora1) 60%, var(--aurora2) 100%)',
                        'gold-gradient': 'linear-gradient(90deg, var(--gold-premium) 0%, var(--gold-light) 60%, var(--aurora1) 100%)'
                    }
                }
            }
        }
    </script>
    -->
    
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="{% static '/static/css/dist/styles.css' %}" rel="stylesheet">
    <link href="{% static 'css/base.css' %}" rel="stylesheet">


    <link rel="icon" type="image/png" href="{% static 'img/dashboard/logo.png' %}">
    <title>{% block title %}VisionPulse - Monitoreo de Salud Visual{% endblock %}</title>
</head>


<body style="min-height:100vh;display:flex; ">
    {% block sidebar %}{% endblock %}
    {% block header %}{% endblock %}
    {% if user.is_authenticated %}
    <!-- Sidebar Overlay (todas las resoluciones) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar(false)"></div>
    <!-- Sidebar Drawer universal -->
    <aside class="sidebar hide " id="sidebar" aria-label="Menú principal">
        <div class="sidebar-header ">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">
                    <i class="fas fa-eye heartbeat" style="color: var(--primary-health);"></i>
                </div>
                <a href="{% url 'security:home' %}" class="sidebar-logo-text" style="text-decoration:none; color:inherit;">
                  VisionPulse
                </a>
            </div>
        </div>
        <nav class="sidebar-nav" aria-label="Navegación principal">
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Principal</h3>
                <a href="{% url 'security:home' %}" class="sidebar-link {% if request.path == '/' %}active{% endif %}" tabindex="0"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
                <a href="{% url 'monitoring:home' %}" class="sidebar-link" tabindex="0"><i class="fas fa-video" style="color: var(--secondary-vision);"></i><span>Monitoreo en Vivo</span></a>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Salud Visual</h3>
                <a href="#" class="sidebar-link" tabindex="0"><i class="fas fa-chart-line" style="color: var(--primary-health);"></i><span>Sesiones</span></a>
                <a href="#" class="sidebar-link" tabindex="0"><i class="fas fa-exclamation-triangle" style="color: var(--warning-fatigue);"></i><span>Alertas</span></a>
                <a href="#" class="sidebar-link" tabindex="0"><i class="fas fa-dumbbell" style="color: var(--accent-eye);"></i><span>Ejercicios</span></a>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-section-title">Reportes</h3>
                <a href="#" class="sidebar-link" tabindex="0"><i class="fas fa-file-medical-alt"></i><span>Reportes</span></a>
                <a href="#" class="sidebar-link" tabindex="0"><i class="fas fa-download"></i><span>Exportar Datos</span></a>
            </div>
            {% if sidebar_menu %}
                <div class="sidebar-section">
                    <h3 class="sidebar-section-title">Módulos</h3>
                    {% with modulos=sidebar_menu.group_module_permission_list|dictsort:"module.order" %}
                        {% for module_perm in modulos %}
                            <a href="/{{ module_perm.module.url }}" class="sidebar-link" tabindex="0">
                                <i class="{{ module_perm.module.icon|default:'fas fa-cube' }}"></i>
                                <span>{{ module_perm.module.name }}</span>
                            </a>
                        {% endfor %}
                    {% endwith %}
                </div>
            
            {% endif %}
        </nav>
    </aside>
    {% endif %}
    <div class="main-wrapper">
        <!-- Header -->
        <header class="header" aria-label="Barra superior" id="mainHeader">
            <div class="header-content">
                <button class="header-button" id="sidebarMenuBtn" onclick="toggleSidebar(true)" aria-label="Abrir menú" style="margin-right:1.1rem;display:inline-flex;"><i class="fas fa-bars"></i></button>
                <div class="sidebar-logo" style="display:flex;align-items:center;gap:0.7rem;">
                    <div class="sidebar-logo-icon">
                        <i class="fas fa-eye heartbeat" style="color: var(--primary-health);"></i>
                    </div>

                    <a href="{% url 'security:home' %}" class="sidebar-logo-text" style="text-decoration:none; color:inherit;">VisionPulse</a>
                </div>
                {% if user.is_authenticated %}
                <div class="header-actions-fixed">
                    <select id="groupSelect" class="header-button group-select-premium" aria-label="Seleccionar grupo" style="margin-left:auto;">
                        <option value="">Seleccionar Grupo</option>
                        {% for group in group_list %}
                        <option value="{{ group.id }}" {% if group.id|stringformat:"s" == request.session.group_id|stringformat:"s" %}selected{% endif %}>{{ group.name }}</option>
                        {% endfor %}
                    </select>
                    <button class="header-button notification-btn-premium" aria-label="Notificaciones" style="margin-left:1.1rem;"><i class="fas fa-bell"></i><span class="notification-badge">3</span></button>
                    <div class="user-menu-premium" style="margin-left:1.1rem;">
                        <button class="user-button-premium" onclick="toggleUserDropdown()" aria-label="Menú de usuario">
                            <div class="user-avatar-premium">{{ user.username|first|upper }}</div>
                            <div class="user-info-premium">
                                <span class="user-name-premium">{{ user.username }}</span>
                               
                            </div>
                            <i class="fas fa-chevron-down" id="userDropdownIcon"></i>
                        </button>
                        <div class="user-dropdown" id="userDropdown">
                            <div class="dropdown-section">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <div class="user-avatar-premium">{{ user.username|first|upper }}</div>
                                    <div>
                                        <div class="user-name-premium">{{ user.username }}</div>
                                        <div style="font-size: 0.75rem; color: #64748b;">{{ user.email|default:"Sin email" }}</div>
                                    </div>
                                </div>
                                {% if group_list.exists %}
                                <div style="background: #f1f5f9; padding: 0.5rem; border-radius: var(--radius-md); margin-top: 0.5rem;">
                                    <span style="font-size: 0.75rem; font-weight: 600; color: var(--primary-blue);">{{ group_list.first.name }}</span>
                                </div>
                                {% endif %}
                            </div>
                            <div class="dropdown-section">
                                <a href="{% url 'security:settings' %}" class="dropdown-link"><i class="fas fa-user"></i><span>Mi Perfil</span></a>
                                <a href="{% url 'security:settings' %}" class="dropdown-link"><i class="fas fa-cog"></i><span>Configuración</span></a>
                                {% if user.is_superuser %}
                                    <a href="{% url 'security:controller' %}" class="dropdown-link"><i class="fas fa-shield-alt"></i><span>Seguridad</span></a>
                                {% endif %}
                            </div>
                            
                            <div class="dropdown-section">
                                <form method="POST" action="{% url 'security:signout' %}">{% csrf_token %}
                                    <button type="submit" class="dropdown-link danger" style="width: 100%; text-align: left;"><i class="fas fa-sign-out-alt"></i><span>Cerrar Sesión</span></button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div style="display: flex; justify-content: flex-end; align-items: center; width: 100%;">
                    <a href="{% url 'security:signin' %}" class="inline-flex items-center gap-2 px-6 py-3 text-white bg-gradient-to-r from-secondary-vision to-accent-eye rounded-full font-semibold shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5"><i class="fas fa-sign-in-alt"></i><span>Iniciar Sesión</span></a>
                </div>
                <style>
                    .premium-login-btn {
                        box-shadow: 0 4px 16px rgba(0,0,0,0.12), 0 1.5px 4px rgba(0,0,0,0.10);
                        border-radius: 2rem;
                        padding: 0.6rem 2rem;
                        font-weight: 600;
                        font-size: 1.1rem;
                        background: linear-gradient(90deg, #4f8cff 0%, #6f4fff 100%);
                        border: none;
                        color: #fff;
                        transition: box-shadow 0.2s, transform 0.2s;
                    }
                    .premium-login-btn:hover {
                        box-shadow: 0 8px 24px rgba(79,140,255,0.18), 0 3px 8px rgba(111,79,255,0.15);
                        transform: translateY(-2px) scale(1.04);
                        background: linear-gradient(90deg, #6f4fff 0%, #4f8cff 100%);
                        color: #fff;
                    }
                </style>
                {% endif %}
            </div>
        </header>
        <div class="main-wrapper" style="flex:1;min-width:0;display:flex;flex-direction:column;">
            <!-- Main Content -->
            <main class="main-content" id="mainContent" style="flex:1;min-width:0;padding-top:72px;">
                <div class="page-content">
                    {% block content %}{% endblock content %}
                </div>
            </main>
        </div>
    </div>
    <!-- Speech Recognition API for voice-to-text (compatible with Chrome, Edge, some Firefox) -->
    <script>
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
    </script>
    <script>
      // Sidebar toggle universal (todas las resoluciones, solo overlay, sin push)
      function toggleSidebar(forceShow) {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const headerContent = document.querySelector('.header-content');
        const sidebarMenuBtnIcons = document.querySelectorAll('#sidebarMenuBtn i');
        // Si no se pasa argumento, alternar
        let show;
        if (typeof forceShow === 'undefined') {
          show = !sidebar.classList.contains('show');
        } else {
          show = !!forceShow;
        }
        if (show) {
          sidebar.classList.remove('hide');
          sidebar.classList.add('show');
          overlay.classList.add('active');
          document.body.style.overflow = 'hidden';
          if(window.innerWidth > 1024 && headerContent) headerContent.classList.add('pushed');
          // Solo color premium al icono (sin animación)
          sidebarMenuBtnIcons.forEach(function(icon){
            icon.classList.add('sidebar-menu-active');
          });
        } else {
          sidebar.classList.remove('show');
          sidebar.classList.add('hide');
          overlay.classList.remove('active');
          document.body.style.overflow = 'auto';
          if(headerContent) headerContent.classList.remove('pushed');
          // Quita el color premium del icono inmediatamente
          sidebarMenuBtnIcons.forEach(function(icon){
            icon.classList.remove('sidebar-menu-active');
          });
        }
      }
      // Cambia el evento del botón para alternar
      document.addEventListener('DOMContentLoaded', function() {
        const sidebarMenuBtn = document.getElementById('sidebarMenuBtn');
        if (sidebarMenuBtn) {
          sidebarMenuBtn.onclick = function() { toggleSidebar(); };
        }
      });
      // Cerrar sidebar con ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') toggleSidebar(false);
      });
      // User dropdown
      function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdown');
        dropdown.classList.toggle('show');
      }
      document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('userDropdown');
        if (dropdown && dropdown.classList.contains('show')) {
          const btn = document.querySelector('.user-button');
          if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.remove('show');
          }
        }
      });
      // Ripple effect mejorado
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('button, .btn, .sidebar-link, .dropdown-link').forEach(el => {
          el.addEventListener('click', function(e) {
            if (el.disabled) return;
            const ripple = document.createElement('span');
            const rect = el.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height) * 1.2;
            const x = e.clientX - rect.left - size / 2;
            const y = e.clientY - rect.top - size / 2;
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.className = 'ripple';
            el.appendChild(ripple);
            setTimeout(() => ripple.remove(), 700);
          });
        });
        // Animación de entrada para sidebar y header
        const sidebar = document.getElementById('sidebar');
        if (sidebar) sidebar.style.animation = 'slideInRight 0.7s cubic-bezier(.4,2,.3,1)';
        const header = document.querySelector('.header');
        if (header) header.style.animation = 'slideInRight 0.7s cubic-bezier(.4,2,.3,1)';
        // Group select
        const groupSelect = document.getElementById('groupSelect');
        if (groupSelect) {
          groupSelect.addEventListener('change', function() {
            const selectedGroupId = this.value;
            if (selectedGroupId) {
              window.location.href = `{% url 'security:home' %}?gpid=${selectedGroupId}`;
            } else {
              window.location.href = `{% url 'security:home' %}`;
            }
          });
        }
      });
      window.addEventListener('resize', function() {
        const headerContent = document.querySelector('.header-content');
        const sidebar = document.getElementById('sidebar');
        if(headerContent && sidebar) {
          if(window.innerWidth > 1024 && sidebar.classList.contains('show')) {
            headerContent.classList.add('pushed');
          } else {
            headerContent.classList.remove('pushed');
          }
        }
      });
    </script>
    <!-- Botpress Cloud Chatbot -->
    <script src="https://cdn.botpress.cloud/webchat/v3.0/inject.js" defer></script>
    <script src="https://files.bpcontent.cloud/2025/07/04/18/20250704185944-CSIIUJEG.js" defer></script>
    {% block css %}{% endblock %}
    {% block js %}{% endblock %}
</body>
</html>