{% load static %}
<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}VisionPulse{% endblock %}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Nunito:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="{% static 'img/dashboard/logo.svg' %}" sizes="32x32">
    <link rel="stylesheet" href="{% static 'css/dist/styles.css' %}">
    {% block extra_css %}{% endblock %}

    <script>
        // Check for saved user preference, system preference, or default to light
        const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>
<body class="bg-peach-75 text-gray-900 font-sans dark:bg-gray-800 dark:text-gray-100 min-h-screen overflow-x-hidden">
    <div class="flex min-h-screen">
        {% if user.is_authenticated %}
    <header class="fixed top-0 left-0 right-0 h-[80px] bg-surface dark:bg-dark-surface border-b border-border-color dark:border-dark-border-color flex items-center justify-between px-6 z-40 shadow-sm">
            <div class="flex items-center gap-4">
                <button class="menu-toggle text-text-primary dark:text-dark-text-primary text-2xl lg:hidden" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="{% url 'security:home' %}" class="flex items-center gap-3">
                    <div class="logo-icon">
                        <img src="{% static 'img/dashboard/logo.svg' %}" alt="VisionPulse Logo" class="h-20 w-20 object-contain" style="box-shadow: none; border: none; outline: none;">
                    </div>
                    <div>
                        <div class="font-black text-2xl text-text-primary dark:text-dark-text-primary" style="font-family: 'Nunito', sans-serif; font-weight: 900;">VisionPulse</div>
                        <div class="text-xs text-text-secondary dark:text-dark-text-secondary">Cuidado visual inteligente</div>
                    </div>
                </a>
            </div>
            
            <div class="flex items-center gap-5">
                <button class="notification-btn dark:text-dark-text-primary dark:hover:bg-dark-background-primary">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </button>
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="user-menu">
                    <div class="hidden sm:block text-right">
                        <div class="font-semibold text-sm text-text-primary dark:text-dark-text-primary">{{ user.get_full_name|default:user.username }}</div>
                        <div class="text-xs text-text-secondary dark:text-dark-text-secondary">{{ user.email }}</div>
                    </div>
                    <div class="user-avatar text-2xl w-14 h-14 flex items-center justify-center bg-[#E8DDD0] rounded-full">{{ user.username|first|upper }}</div>
                </div>
            </div>
        </header>

    <aside id="sidebar" class="fixed top-[80px] left-0 h-[calc(100vh-80px)] bg-surface border-r border-border-color z-30 transition-all duration-300 w-72 dark:bg-dark-surface dark:border-dark-border-color">
            <nav class="flex flex-col h-full">
                <div class="flex-1 p-4 space-y-2 overflow-y-auto">
                    {% for menu_item in sidebar_menu %}
                        <div class="nav-section-title mt-4">{{ menu_item.name }}</div>
                        
                        {% for module in menu_item.modules %}
                            <a href="{% url module.url %}" class="nav-item {% if request.resolver_match.view_name == module.url %}active{% endif %}">
                                <i class="{{ module.icon }} fa-fw nav-icon"></i>
                                <span class="nav-text">{{ module.name }}</span>
                            </a>
                        {% endfor %}
                    {% endfor %}
                </div>
                <button id="collapseBtn" class="collapse-btn">
                    <i id="collapseIcon" class="fas fa-chevron-left transition-transform duration-300"></i>
                </button>
            </nav>
        </aside>
        {% endif %}

    <main id="mainContent" class="flex-1 pt-[80px] transition-all duration-300 {% if user.is_authenticated %}ml-72{% endif %}">
            <div class="pt-4 pb-4 px-4 md:pt-6 md:pb-6 md:px-8">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const htmlEl = document.documentElement;
        const icon = themeToggle.querySelector('i');

        // Function to update the icon based on current theme
        const updateThemeIcon = () => {
            const isDark = htmlEl.classList.contains('dark');
            icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        };

        themeToggle.addEventListener('click', () => {
            htmlEl.classList.toggle('dark');
            const isDark = htmlEl.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon();
        });

        // Initial icon update
        updateThemeIcon();

    // Sidebar Collapse
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const collapseBtn = document.getElementById('collapseBtn');
    const collapseIcon = document.getElementById('collapseIcon');

    if (collapseBtn) {
        collapseBtn.addEventListener('click', () => {
            const isCollapsed = sidebar.classList.contains('w-20');
            if (isCollapsed) {
                // Expandir
                sidebar.classList.replace('w-20', 'w-72');
                mainContent.classList.replace('ml-20', 'ml-72');
                collapseIcon.classList.remove('rotate-180');
                sidebar.querySelectorAll('.nav-text, .nav-section-title').forEach(el => {
                    el.classList.remove('opacity-0', 'hidden');
                    });
                } else {
                    // Colapsar
                    sidebar.classList.replace('w-72', 'w-20');
                    mainContent.classList.replace('ml-72', 'ml-20');
                    collapseIcon.classList.add('rotate-180');
                    sidebar.querySelectorAll('.nav-text, .nav-section-title').forEach(el => {
                        el.classList.add('opacity-0', 'hidden');
                    });
                }
            });
        }
    });
</script>
    <!-- Modal del Ejercicio -->
    <div id="exercise-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div id="exercise-modal" class="bg-surface dark:bg-dark-surface max-w-xl w-full rounded-2xl p-8 shadow-2xl relative transform transition-all duration-300 scale-95 opacity-0">
            <!-- El contenido del modal se generará dinámicamente con JavaScript -->
        </div>
    </div>

    {% block extra_js %}{% endblock %}
</body>
</html>