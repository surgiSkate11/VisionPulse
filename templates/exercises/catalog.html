{% extends 'base.html' %}
{% load static %}

{% block title %}Ejercicios Oculares | VisionPulse{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-text-primary dark:text-dark-text-primary mb-1">Ejercicios Oculares</h1>
        <p class="text-text-secondary dark:text-dark-text-secondary">Rutinas guiadas para el cuidado de tu visión.</p>
    </div>

    {% if exercises %}
    <div class="bg-gradient-to-tr from-accent-peach to-amber-200 dark:from-dark-accent-peach dark:to-amber-800 rounded-2xl p-8 mb-10 shadow-lg dark:shadow-xl dark:shadow-black/20">
        <div class="inline-flex items-center gap-2 bg-white/50 dark:bg-dark-surface/50 text-text-primary dark:text-dark-text-primary font-medium px-3 py-1 rounded-full text-sm mb-4">
            ✨ Recomendado para ti
        </div>
        <h2 class="text-2xl font-bold text-text-primary dark:text-dark-text-primary mb-2">{{ exercises.0.title }}</h2>
        <p class="text-text-secondary dark:text-dark-text-secondary opacity-90 mb-5 max-w-lg">{{ exercises.0.description }}</p>
        <button class="start-exercise-btn bg-accent-green hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-transform hover:scale-105 shadow-md"
                data-exercise-id="{{ exercises.0.id }}"
                data-url="{% url 'exercises:exercise_data' exercises.0.id %}">
            <i class="fas fa-play mr-2"></i>
            Comenzar Ahora
        </button>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for exercise in exercises %}
        <div class="card p-6 flex flex-col text-left dark:bg-dark-surface dark:border-dark-border-color transition hover:-translate-y-1 hover:shadow-xl">
            <div class="w-14 h-14 rounded-xl bg-accent-peach dark:bg-dark-accent-peach flex items-center justify-center mb-4">
                <i class="{{ exercise.icon_class }} text-2xl text-text-primary dark:text-dark-text-primary"></i>
            </div>
            <h3 class="text-lg font-semibold text-text-primary dark:text-dark-text-primary mb-2 flex-grow">{{ exercise.title }}</h3>
            <p class="text-text-secondary dark:text-dark-text-secondary text-sm mb-4">{{ exercise.description }}</p>
            <div class="text-sm text-text-secondary dark:text-dark-text-secondary mb-4 border-t border-border-color dark:border-dark-border-color pt-4 flex items-center justify-between">
                <span>
                    <i class="fas fa-clock mr-1.5"></i>
                    Aprox. {{ exercise.total_duration_minutes }} min
                </span>
                <span class="font-medium text-accent-green dark:text-dark-accent-green">
                    {{ exercise.steps.count }} Pasos
                </span>
            </div>
            <button class="start-exercise-btn w-full bg-accent-green/10 text-accent-green dark:bg-dark-accent-green/20 dark:text-dark-accent-green font-semibold py-3 rounded-lg hover:bg-accent-green hover:text-white dark:hover:bg-dark-accent-green dark:hover:text-white transition"
                    data-exercise-id="{{ exercise.id }}"
                    data-url="{% url 'exercises:exercise_data' exercise.id %}">
                Iniciar
            </button>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-12 card dark:bg-dark-surface dark:border-dark-border-color">
            <i class="fas fa-ghost text-4xl text-gray-400 mb-4"></i>
            <p class="text-text-secondary dark:text-dark-text-secondary">No hay ejercicios disponibles en este momento.</p>
            <p class="text-xs text-text-secondary dark:text-dark-text-secondary mt-1">Ejecuta 'python manage.py populate_exercises' para crearlos.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Selección de Elementos del DOM ---
    const modalOverlay = document.getElementById('exercise-modal-overlay');
    const modal = document.getElementById('exercise-modal');
    const startButtons = document.querySelectorAll('.start-exercise-btn');

    // --- Variables de Estado del Ejercicio ---
    let currentExercise = null;
    let currentStepIndex = 0;
    let stepTimeLeft = 0;
    let totalTimeLeft = 0;
    let timerInterval = null;
    let isPaused = false;

    // --- Funciones para controlar el Modal ---
    function openModal() {
        modalOverlay.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('scale-95', 'opacity-0'), 50);
    }

    function closeModal() {
        clearInterval(timerInterval);
        modal.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modalOverlay.classList.add('hidden');
            modal.innerHTML = ''; // Limpia el contenido al cerrar
        }, 300);
    }

    // --- Lógica Principal del Ejercicio ---
    async function startExercise(exerciseId, url) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('No se pudo cargar el ejercicio.');
            currentExercise = await response.json();
            
            if (!currentExercise.steps || currentExercise.steps.length === 0) {
                alert('Este ejercicio no tiene pasos definidos.');
                return;
            }

            currentStepIndex = 0;
            isPaused = false;
            totalTimeLeft = currentExercise.total_duration;
            
            renderModalContent(); // Construye el HTML del modal
            startStep(); // Inicia el primer paso
            openModal();

        } catch (error) {
            console.error("Error al iniciar el ejercicio:", error);
            alert(error.message);
        }
    }

    function startStep() {
        const step = currentExercise.steps[currentStepIndex];
        stepTimeLeft = step.duration_seconds;
        updateStepUI();
        
        clearInterval(timerInterval);
        timerInterval = setInterval(tick, 1000);
    }
    
    function tick() {
        if (isPaused) return;

        stepTimeLeft--;
        totalTimeLeft--;
        updateTimerUI();

        if (stepTimeLeft <= 0) {
            moveToNextStep();
        }
    }

    function moveToNextStep() {
        if (currentStepIndex < currentExercise.steps.length - 1) {
            currentStepIndex++;
            startStep();
        } else {
            completeExercise();
        }
    }

    function togglePause() {
        isPaused = !isPaused;
        const pauseBtn = document.getElementById('pause-btn');
        if (pauseBtn) {
            pauseBtn.innerHTML = isPaused 
                ? '<i class="fas fa-play mr-2"></i>Reanudar'
                : '<i class="fas fa-pause mr-2"></i>Pausar';
        }
    }

    function completeExercise() {
        clearInterval(timerInterval);
        modal.innerHTML = `
            <h2 class="text-3xl font-bold text-text-primary dark:text-dark-text-primary mb-4">¡Ejercicio Completado!</h2>
            <i class="fas fa-check-circle text-6xl text-accent-green dark:text-dark-accent-green mb-4 animate-pulse"></i>
            <p class="text-text-secondary dark:text-dark-text-secondary mb-6">¡Gran trabajo! Has fortalecido tu salud visual.</p>
            <button id="close-completion-btn" class="w-full bg-accent-green text-white font-semibold py-3 rounded-lg hover:bg-opacity-90 transition">Cerrar</button>
        `;
        document.getElementById('close-completion-btn').addEventListener('click', closeModal);
    }

    // --- Funciones para Actualizar la Interfaz (UI) ---
    function renderModalContent() {
        modal.innerHTML = `
            <button id="modal-close-btn" class="absolute top-4 right-4 w-10 h-10 rounded-full bg-black/10 dark:bg-white/10 hover:bg-black/20 dark:hover:bg-white/20 flex items-center justify-center text-xl transition-transform hover:rotate-90">
                <i class="fas fa-times"></i>
            </button>
            <div class="mb-6">
                <h2 id="exercise-title" class="text-3xl font-bold text-text-primary dark:text-dark-text-primary"></h2>
                <p id="total-timer" class="text-sm text-text-secondary dark:text-dark-text-secondary"></p>
            </div>
            <div class="w-40 h-40 mx-auto bg-accent-peach/50 dark:bg-dark-accent-peach/50 rounded-full flex items-center justify-center mb-6">
                <i id="step-icon" class="text-6xl text-text-primary dark:text-dark-text-primary"></i>
            </div>
            <div class="bg-white/50 dark:bg-dark-surface/50 rounded-2xl p-6 shadow-inner">
                <div class="flex justify-between items-center text-sm text-text-secondary dark:text-dark-text-secondary mb-3">
                    <span>PASO ACTUAL</span>
                    <span id="step-badge"></span>
                </div>
                <p id="step-instruction" class="text-xl font-semibold mb-4 text-text-primary dark:text-dark-text-primary"></p>
                <div class="w-full bg-border-color dark:bg-dark-border-color rounded-full h-2.5">
                    <div id="progress-bar" class="bg-accent-green dark:bg-dark-accent-green h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            <div class="flex gap-4 mt-6">
                <button id="pause-btn" class="flex-1 bg-gray-200 dark:bg-gray-700 text-text-primary dark:text-dark-text-primary font-semibold py-3 rounded-lg transition hover:bg-gray-300"><i class="fas fa-pause mr-2"></i>Pausar</button>
                <button id="finish-btn" class="flex-1 bg-alert-coral/20 text-alert-coral dark:bg-alert-coral/30 font-semibold py-3 rounded-lg transition hover:bg-alert-coral hover:text-white">Terminar</button>
            </div>
        `;
        // Añadir listeners a los nuevos botones
        document.getElementById('pause-btn').addEventListener('click', togglePause);
        document.getElementById('finish-btn').addEventListener('click', closeModal);
        document.getElementById('modal-close-btn').addEventListener('click', closeModal);
    }

    function updateStepUI() {
        const step = currentExercise.steps[currentStepIndex];
        document.getElementById('exercise-title').textContent = currentExercise.title;
        document.getElementById('step-icon').className = `${step.icon_class} text-6xl text-text-primary dark:text-dark-text-primary transition-transform duration-300 transform group-hover:scale-110`;
        document.getElementById('step-instruction').textContent = step.instruction;
        document.getElementById('step-badge').textContent = `${currentStepIndex + 1} / ${currentExercise.steps.length}`;
    }

    function updateTimerUI() {
        const minutes = Math.floor(totalTimeLeft / 60);
        const seconds = totalTimeLeft % 60;
        document.getElementById('total-timer').textContent = `Tiempo restante: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        const progressPercentage = ((currentStepIndex + 1) / currentExercise.steps.length) * 100;
        document.getElementById('progress-bar').style.width = `${progressPercentage}%`;
    }

    // --- Listeners Iniciales ---
    startButtons.forEach(button => {
        button.addEventListener('click', () => {
            const exerciseId = button.dataset.exerciseId;
            const url = button.dataset.url;
            startExercise(exerciseId, url);
        });
    });

    modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) closeModal();
    });
});
</script>
{% endblock %}