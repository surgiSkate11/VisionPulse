{% extends 'base.html' %}
{% load static %}
{% block title %}Monitoreo en Vivo | VisionPulse{% endblock %}

{% block extra_css %}
<style>
    .hidden { display: none !important; }
    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    #videoStream {
        width: 100%;
        height: auto;
        max-height: 480px;
        background: #000;
        border-radius: 0.5rem;
    }
    .video-container {
        min-height: 360px;
    }
    .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: .5; }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header flex flex-col items-start mb-4">
    <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
        <i class="fas fa-chart-line text-cyan-600"></i>
        Monitoreo en Vivo
    </h1>
    <p class="text-gray-500 mt-2">Sistema de detección facial y monitoreo de fatiga en tiempo real</p>
</div>

<!-- Panel de Control Principal -->

<!-- Video feed y métricas -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Video feed -->
    <div class="video-container bg-gradient-to-r from-cyan-50 to-blue-100 rounded-2xl shadow-xl p-6 border border-cyan-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Captura en Vivo</h3>
        
        <div class="relative bg-black rounded-lg overflow-hidden mb-4">
            <img id="videoStream" 
                 src="" 
                 class="w-full h-auto mx-auto"
                 style="max-height: 480px; display: none;">
            <div id="videoPlaceholder" 
                 class="w-full flex items-center justify-center text-white"
                 style="min-height: 360px; background: #1a1a1a;">
                <div class="text-center">
                    <svg class="w-20 h-20 mx-auto mb-2 text-gray-600 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                        </path>
                    </svg>
                    <span class="text-xl font-bold text-orange-700" id="camera-status">Cámara Desactivada</span>
                    <p class="text-gray-700 text-base font-medium" id="camera-message">Inicia monitoreo para comenzar a monitorear tu salud visual en tiempo real</p>
                </div>
            </div>
        </div>
        <!-- no fuciona por eso se desactivo 
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-2">
                <div id="face-indicator" class="w-3 h-3 rounded-full bg-red-500"></div>
                <span class="text-sm">Rostro</span>
            </div>
            <div class="flex items-center space-x-2">
                <div id="eyes-indicator" class="w-3 h-3 rounded-full bg-red-500"></div>
                <span class="text-sm">Ojos</span>
            </div>
        </div>
        -->
    </div>

    <!-- Métricas en tiempo real -->
    <div class="bg-gradient-to-r from-blue-50 to-cyan-100 rounded-2xl shadow-xl p-6 border border-blue-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Métricas en Tiempo Real</h3>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-white rounded-lg p-4 shadow">
                <div class="text-sm text-gray-500 mb-1">Apertura de Ojos (EAR)</div>
                <div id="ear-metric" class="text-2xl font-bold text-blue-600">--</div>
                <div id="ear-debug" class="text-xs text-gray-400 mt-1">faces: - | eyes: -</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow">
                <div class="text-sm text-gray-500 mb-1">Parpadeos Totales</div>
                <div id="blinks-metric" class="text-2xl font-bold text-blue-600">0</div>
                <div id="blinks-debug" class="text-xs text-gray-400 mt-1">debug_avg_ear: -</div>
            </div>
        </div>

        <div id="sessionInfoCard" class="bg-white rounded-lg p-4 shadow mb-4 hidden">
            <div class="text-sm text-gray-500 mb-2">Sesión Activa</div>
            <div class="text-sm text-gray-800">
                <p><strong>ID:</strong> <span id="sessionId">-</span></p>
                <p><strong>Inicio:</strong> <span id="sessionStart">-</span></p>
                <p><strong>Duración:</strong> <span id="sessionDuration">00:00</span></p>
            </div>
        </div>

        <div class="bg-white rounded-lg p-4 shadow mb-4">
            <div class="text-sm text-gray-500 mb-2">Estado del Sistema</div>
            <div id="status-text" class="text-lg font-semibold text-gray-800">Esperando inicio...</div>
            <div id="message-text" class="text-sm text-gray-600 mt-1">Presiona "Iniciar monitoreo" para comenzar</div>
        </div>

        <!--Botones Here-->
         <div class="flex justify-center gap-4 p-8">
        <button id="startBtn"
            class="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-blue-600 hover:to-cyan-600 text-white font-semibold py-3 px-8 rounded-xl transition-all duration-300 flex items-center justify-center shadow-lg hover:shadow-cyan-500/50 transform hover:scale-105 hover:-translate-y-1 active:scale-95">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                </path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Iniciar monitoreo
        </button>

        <button id="stopBtn" disabled
            class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-pink-600 hover:to-red-700 text-white font-semibold py-3 px-8 rounded-xl transition-all duration-300 shadow-lg hover:shadow-pink-500/50 transform hover:scale-105 hover:-translate-y-1 active:scale-95 flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
            </svg>
            Detener
        </button>
    </div>


        <div id="error-alert" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
            <span id="error-text"></span>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== INICIALIZANDO SISTEMA DE MONITOREO ===');
    
    // Estado global
    let sessionId = null;
    let sessionStartTime = null;
    let durationInterval = null;

    // Elementos DOM
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const videoStream = document.getElementById('videoStream');
    const videoPlaceholder = document.getElementById('videoPlaceholder');
    const sessionInfoCard = document.getElementById('sessionInfoCard');
    
    // Funciones de utilidad
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    function formatTime(date) {
        return date.toLocaleString('es-ES', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    function updateDuration() {
        if (!sessionStartTime) return;
        const now = new Date();
        const diff = Math.floor((now - sessionStartTime) / 1000);
        const minutes = Math.floor(diff / 60);
        const seconds = diff % 60;
        document.getElementById('sessionDuration').textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function updateStatus(status, message) {
        document.getElementById('camera-status').textContent = status;
        document.getElementById('camera-message').textContent = message;
        document.getElementById('status-text').textContent = status;
        document.getElementById('message-text').textContent = message;
    }

    function showError(message) {
        console.error('Error:', message);
        const errorDiv = document.getElementById('error-message');
        const errorAlert = document.getElementById('error-alert');
        const errorText = document.getElementById('error-text');
        
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        if (errorAlert && errorText) {
            errorText.textContent = message;
            errorAlert.classList.remove('hidden');
        }
        updateStatus('Error', message);
    }

    function updateUI(isActive) {
        if (isActive) {
            startBtn.disabled = true;
            stopBtn.disabled = false;
            videoStream.style.display = 'block';
            videoPlaceholder.style.display = 'none';
            sessionInfoCard.classList.remove('hidden');
            
            // Ocultar mensajes de error
            document.getElementById('error-message')?.classList.add('hidden');
            document.getElementById('error-alert')?.classList.add('hidden');
        } else {
            startBtn.disabled = false;
            stopBtn.disabled = true;
            videoStream.style.display = 'none';
            videoPlaceholder.style.display = 'flex';
            sessionInfoCard.classList.add('hidden');
        }
    }

    // Iniciar monitoreo
    startBtn.addEventListener('click', async function() {
        console.log('=== INICIANDO MONITOREO ===');
        updateStatus('Iniciando...', 'Conectando con el servidor...');
        
        try {
            const response = await fetch('{% url "monitoring:start_webcam_test" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            console.log('Respuesta del servidor:', data);

            if (data.status === 'success') {
                sessionId = data.session_id;
                sessionStartTime = new Date();
                
                // Actualizar información de sesión
                document.getElementById('sessionId').textContent = sessionId;
                document.getElementById('sessionStart').textContent = formatTime(sessionStartTime);
                
                // Iniciar contador de duración
                durationInterval = setInterval(updateDuration, 1000);
                
                // Actualizar UI
                updateUI(true);
                updateStatus('Monitoreo Activo', 'Detectando rostros y ojos en tiempo real');
                
                // Cargar stream de video
                const videoUrl = '{% url "monitoring:video_feed" %}?t=' + new Date().getTime();
                videoStream.src = videoUrl;
                // Iniciar polling de métricas
                startMetricsPolling();
                
                console.log('✅ Monitoreo iniciado correctamente');
                alert(`✅ ${data.message}\nSesión ID: ${sessionId}`);
            } else {
                showError(data.message);
                alert('❌ Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error al iniciar:', error);
            showError('Error de conexión: ' + error.message);
            alert('❌ Error al iniciar monitoreo: ' + error.message);
        }
    });

    // Detener monitoreo
    stopBtn.addEventListener('click', async function() {
        console.log('=== DETENIENDO MONITOREO ===');
        updateStatus('Deteniendo...', 'Finalizando sesión...');
        
        // Detener stream de video
        videoStream.src = '';
        
        // Detener contador de duración
        if (durationInterval) {
            clearInterval(durationInterval);
            durationInterval = null;
        }
        
        try {
            const response = await fetch('{% url "monitoring:stop_webcam_test" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            console.log('Respuesta Stop:', data);

            if (data.status === 'success') {
                const duration = data.duration_seconds || 0;
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                
                updateUI(false);
                updateStatus('Monitoreo Detenido', `Sesión finalizada. Duración: ${minutes}m ${seconds}s`);
                
                sessionId = null;
                sessionStartTime = null;
                
                alert(`✅ ${data.message}\nDuración: ${minutes}m ${seconds}s`);
                
                // Recargar página después de 1.5 segundos
                // Parar polling antes de recargar
                stopMetricsPolling();
                setTimeout(() => { location.reload(); }, 1500);
            } else {
                showError(data.message);
                // Recargar de todas formas
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }
        } catch (error) {
            console.error('Error al detener:', error);
            showError('Error al detener: ' + error.message);
            // Recargar de todas formas
            stopMetricsPolling();
            setTimeout(() => { location.reload(); }, 2000);
        }
    });

    // Detectar cierre de ventana
    window.addEventListener('beforeunload', function(e) {
        if (sessionId) {
            // Intentar detener la sesión
            navigator.sendBeacon(
                '{% url "monitoring:stop_webcam_test" %}',
                new URLSearchParams({
                    'csrfmiddlewaretoken': getCookie('csrftoken')
                })
            );
        }
    });

    // Inicializar UI
    updateUI(false);
    console.log('=== SISTEMA LISTO ===');
});
</script>

<script>
// Polling for session metrics
let metricsInterval = null;
function startMetricsPolling() {
    if (metricsInterval) return;
    metricsInterval = setInterval(async () => {
        try {
            const resp = await fetch('{% url "monitoring:api_session_metrics" %}');
            if (!resp.ok) return;
            const data = await resp.json();
            const earEl = document.getElementById('ear-metric');
            const blinksEl = document.getElementById('blinks-metric');
            if (earEl) earEl.textContent = (data.avg_ear !== undefined) ? data.avg_ear.toFixed(2) : '--';
            if (blinksEl) blinksEl.textContent = (data.total_blinks !== undefined) ? data.total_blinks : '0';
            // debug fields
            const earDebug = document.getElementById('ear-debug');
            const blinksDebug = document.getElementById('blinks-debug');
            if (earDebug) earDebug.textContent = `faces: ${data.faces ?? '-'} | eyes: ${data.eyes ?? '-'}`;
            if (blinksDebug) blinksDebug.textContent = `debug_avg_ear: ${data.debug_avg_ear !== undefined ? data.debug_avg_ear.toFixed(3) : '-'}`;
        } catch (e) {
            console.error('Error polling metrics:', e);
        }
    }, 1000);
}

function stopMetricsPolling() {
    if (metricsInterval) {
        clearInterval(metricsInterval);
        metricsInterval = null;
    }
}
</script>

<!-- Tarjetas de métricas -->
<div class="monitoring-dashboard bg-white rounded-2xl shadow-xl p-8 border border-blue-100 mb-8 mt-8">
    <div class="dashboard-cards flex gap-6 mb-2">
        <div class="card flex-1 bg-gradient-to-br from-cyan-50 to-blue-100 rounded-xl p-6 border border-cyan-200 shadow-md hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
            <div class="card-icon text-cyan-600 text-4xl mb-4">
                <i class="fas fa-clock"></i>
            </div>
            <div class="card-content">
                <h3 class="text-gray-700 font-semibold text-sm uppercase tracking-wide mb-2">Tiempo Total</h3>
                <span class="metric text-3xl font-bold text-cyan-700">{{ total_monitoring_time|default:0 }}</span>
            </div>
        </div>

        <div class="card flex-1 bg-gradient-to-br from-blue-50 to-cyan-100 rounded-xl p-6 border border-blue-200 shadow-md hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
            <div class="card-icon text-blue-600 text-4xl mb-4">
                <i class="fas fa-list"></i>
            </div>
            <div class="card-content">
                <h3 class="text-gray-700 font-semibold text-sm uppercase tracking-wide mb-2">Total Sesiones</h3>
                <span class="metric text-3xl font-bold text-blue-700">{{ recent_sessions|length }}</span>
            </div>
        </div>

        <div class="card flex-1 bg-gradient-to-br from-pink-50 to-pink-100 rounded-xl p-6 border border-pink-200 shadow-md hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
            <div class="card-icon text-pink-600 text-4xl mb-4">
                <i class="fas fa-heart-pulse"></i>
            </div>
            <div class="card-content">
                <h3 class="text-gray-700 font-semibold text-sm uppercase tracking-wide mb-2">Puntaje de Salud</h3>
                <span class="metric text-3xl font-bold text-pink-700">85/100</span>
            </div>
        </div>
    </div>
</div>

<!-- Sesiones Recientes -->
<div class="monitoring-dashboard bg-white rounded-2xl shadow-xl p-8 border border-blue-100 mb-8">
    <div class="sessions-table">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
                <i class="fas fa-history text-cyan-600"></i>
                Sesiones Recientes
            </h2>
            <a href="{% url 'monitoring:session_list' %}" 
               class="bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-300 flex items-center gap-2">
                <i class="fas fa-list"></i>
                Ver todas las sesiones
            </a>
        </div>
        <div class="table-container bg-blue-50 rounded-xl border border-blue-200 overflow-hidden shadow-inner">
            <table class="w-full">
                <thead class="bg-gradient-to-r from-cyan-700 to-blue-800 text-white">
                    <tr>
                        <th class="px-6 py-4 text-left font-bold uppercase tracking-wider text-sm">Fecha</th>
                        <th class="px-6 py-4 text-left font-bold uppercase tracking-wider text-sm">Duración</th>
                        <th class="px-6 py-4 text-left font-bold uppercase tracking-wider text-sm">Parpadeos</th>
                        <th class="px-6 py-4 text-left font-bold uppercase tracking-wider text-sm">Alertas</th>
                        <th class="px-6 py-4 text-left font-bold uppercase tracking-wider text-sm">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in recent_sessions %}
                    <tr class="border-t border-blue-200 hover:bg-blue-100 transition-colors">
                        <td class="px-6 py-4 text-sm text-gray-700">
                            {{ session.start_time|date:"d/m/Y H:i" }}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-700">
                        {% if session.duration_seconds %}
                            {{ session.duration_hms }}
                        {% else %}
                            0
                        {% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-700">
                            {{ session.total_blinks|default:0 }}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-700">
                            {{ session.alerts_count|default:0 }}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-700">
                            <a href="{% url 'monitoring:session_detail' session.id %}" 
                                class="text-cyan-600 hover:text-cyan-800 font-medium">
                                Ver detalles
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="no-data px-6 py-12 text-center">
                            <div class="flex flex-col items-center justify-center text-blue-400">
                                <i class="fas fa-info-circle text-5xl mb-4 text-cyan-400"></i>
                                <p class="text-lg font-medium">No hay sesiones registradas aún. ¡Inicia tu primera sesión de monitoreo!</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}