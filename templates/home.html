{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="welcome-section mb-4">
    <h1 class="text-3xl font-bold text-text-primary dark:text-dark-text-primary mb-1">Bienvenido/a, {{ user.get_full_name|default:user.username }}</h1>
    <p class="text-base text-text-secondary dark:text-dark-text-secondary">Monitoreo y cuidado inteligente para tu salud visual</p>
</div>

<div class="stats-grid grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="stat-card bg-white dark:bg-dark-surface border border-border-color dark:border-dark-border-color rounded-[2.5rem] p-5">
        <div class="stat-header flex items-center gap-3 mb-2">
            <div class="stat-icon clock bg-[#F9E5D8] text-[#8B6F47] w-12 h-12 rounded-full flex items-center justify-center">
                <i class="fas fa-clock text-lg"></i>
            </div>
            <span class="stat-title text-base text-text-secondary dark:text-dark-text-secondary font-normal">Tiempo Pantalla Diario</span>
        </div>
    <div class="stat-value text-3xl font-extrabold text-text-primary dark:text-dark-text-primary mb-0.5" style="font-family: 'Montserrat', sans-serif; font-weight: 800;">{{ total_hours }}h</div>
        <div class="stat-label text-xs text-text-secondary dark:text-dark-text-secondary">Promedio diario</div>
    </div>
    <div class="stat-card bg-white dark:bg-dark-surface border border-border-color dark:border-dark-border-color rounded-[2.5rem] p-5">
        <div class="stat-header flex items-center gap-3 mb-2">
            <div class="stat-icon eye bg-[#FCE8DC] text-[#D4794D] w-12 h-12 rounded-full flex items-center justify-center">
                <i class="fas fa-eye text-lg"></i>
            </div>
            <span class="stat-title text-base text-text-secondary dark:text-dark-text-secondary font-normal">Ritmo de Parpadeo</span>
        </div>
    <div class="stat-value text-3xl font-extrabold text-text-primary dark:text-dark-text-primary mb-0.5" style="font-family: 'Montserrat', sans-serif; font-weight: 800;">{{ avg_blink_rate }}</div>
        <div class="stat-label text-xs text-text-secondary dark:text-dark-text-secondary flex items-center gap-1">
            <i class="fas fa-arrow-down text-xs text-orange-500"></i>
            <span>Ideal: 15-20 parpadeos/min</span>
        </div>
    </div>
    <div class="stat-card bg-white dark:bg-dark-surface border border-border-color dark:border-dark-border-color rounded-[2.5rem] p-5">
        <div class="stat-header flex items-center gap-3 mb-2">
            <div class="stat-icon coffee bg-[#E8DDD0] text-[#8B7355] w-12 h-12 rounded-full flex items-center justify-center">
                <i class="fas fa-coffee text-lg"></i>
            </div>
            <span class="stat-title text-base text-text-secondary dark:text-dark-text-secondary font-normal">Pausas Completadas</span>
        </div>
    <div class="stat-value text-3xl font-extrabold text-text-primary dark:text-dark-text-primary mb-0.5" style="font-family: 'Montserrat', sans-serif; font-weight: 800;">{{ completed_breaks }}/{{ recommended_breaks }}</div>
        <div class="stat-label text-xs text-text-secondary dark:text-dark-text-secondary">Completadas hoy</div>
    </div>
</div>

<div class="main-grid grid grid-cols-1 lg:grid-cols-3 gap-4">
    <!-- Columna izquierda -->
    <div class="left-column space-y-4">
        <!-- Estado Visual -->
        <div class="card bg-[#FAFAFA] dark:bg-dark-surface border border-border-color dark:border-dark-border-color rounded-[2.5rem] p-5">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-text-primary dark:text-dark-text-primary">Estado Visual</h2>
            <span id="visualStateBadge" class="text-xs font-medium px-3 py-1 rounded-full text-white"
                data-color="{{ visual_state_color }}">
                    {{ visual_state_label }}
                </span>
            </div>
            <div class="visual-status">
                <div class="relative mb-6">
                    <div class="progress-bar w-full h-6 rounded-full relative overflow-hidden" style="background: linear-gradient(90deg, #B71C1C 0%, #E65100 33%, #FBC02D 66%, #8BC34A 85%, #D3D3D3 100%); margin-top: 32px;">
                    </div>
                    <div id="visualProgressIndicator" class="progress-indicator absolute top-1/2 -translate-y-1/2 w-1 h-8 bg-[#2C2C2C] rounded-sm" data-left="{{ visual_status }}"></div>
                    <span id="visualProgressValue" class="absolute -top-7 text-sm font-semibold text-text-primary dark:text-dark-text-primary" style="padding-top:2px;" data-value="{{ visual_status }}">0%</span>
                </div>
                <p class="status-text text-sm italic text-center text-text-secondary dark:text-dark-text-secondary leading-relaxed">
                    {% if visual_status >= 85 %}
                        ¡Excelente! Tu salud visual está en estado óptimo.
                    {% elif visual_status >= 70 %}
                        Muy bien. Tu salud visual es muy buena, sigue así.
                    {% elif visual_status >= 55 %}
                        Estado aceptable. Considera tomar descansos regulares.
                    {% elif visual_status >= 40 %}
                        Precaución: Se detecta fatiga leve. Realiza ejercicios visuales.
                    {% else %}
                        Atención: Fatiga visual elevada. Toma un descanso ahora.
                    {% endif %}
                </p>
            </div>
        </div>
        
        <!-- Atajos de Acción -->
        <div class="shortcuts-container flex flex-col gap-3 items-center">
            <a href="{% url 'monitoring:live_session' %}" class="action-card flex items-center justify-between px-7 py-4 bg-[#FAFAFA] dark:bg-dark-surface border-none rounded-3xl shadow-sm cursor-pointer hover:shadow-md transition-shadow w-full max-w-xl">
                <div class="flex items-center w-full justify-between">
                    <div class="flex items-center gap-4 ml-6">
                        <i class="fas fa-video text-2xl text-[#5C5242]"></i>
                        <div class="action-content text-left">
                            <h3 class="font-semibold text-base text-[#2C2C2C] dark:text-dark-text-primary mb-0">Iniciar Monitoreo</h3>
                            <p class="text-sm text-[#8B8B8B] dark:text-dark-text-secondary leading-tight">Comienza una nueva sesión de<br>monitoreo visual en tiempo real</p>
                        </div>
                    </div>
                    <div class="action-play-btn w-9 h-9 bg-[#5C5242] rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-play text-white text-lg ml-0.5"></i>
                    </div>
                </div>
            </a>
            <a href="{% url 'exercises:catalog' %}" class="action-card flex items-center justify-between px-7 py-4 bg-[#FAFAFA] dark:bg-dark-surface border-none rounded-3xl shadow-sm cursor-pointer hover:shadow-md transition-shadow w-full max-w-xl">
                <div class="flex items-center w-full justify-between">
                    <div class="flex items-center gap-4 ml-6">
                        <i class="fas fa-dumbbell text-2xl text-[#5C5242]"></i>
                        <div class="action-content text-left">
                            <h3 class="font-semibold text-base text-[#2C2C2C] dark:text-dark-text-primary mb-0">Realizar Ejercicios</h3>
                            <p class="text-sm text-[#8B8B8B] dark:text-dark-text-secondary leading-tight">Realiza ejercicios guiados<br>para reducir la fatiga visual</p>
                        </div>
                    </div>
                    <div class="action-play-btn w-9 h-9 bg-[#5C5242] rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-play text-white text-lg ml-0.5"></i>
                    </div>
                </div>
            </a>
        </div>
    </div>
    
    <!-- Monitor de Actividad Visual - Columna derecha (2 columnas) -->
    <div class="card bg-white dark:bg-dark-surface border border-border-color dark:border-dark-border-color rounded-[2.5rem] p-5 lg:col-span-2">
        <h2 class="text-lg font-bold text-text-primary dark:text-dark-text-primary mb-0.5">Monitor de Actividad Visual</h2>
        <p class="text-xs text-text-secondary dark:text-dark-text-secondary mb-4">Actividad de hoy</p>
        <div class="chart-legend flex gap-8 mb-4 justify-center w-full">
            <div class="legend-item flex items-center gap-2 text-xs text-text-secondary dark:text-dark-text-secondary">
                <div class="legend-dot blinks w-3 h-3 rounded-full bg-[#A8B5A8]"></div>
                <span>Parpadeos/min</span>
            </div>
            <div class="legend-item flex items-center gap-2 text-xs text-text-secondary dark:text-dark-text-secondary">
                <div class="legend-dot rest w-3 h-3 rounded-full bg-[#E89F5F]"></div>
                <span>Descansos</span>
            </div>
        </div>
        <div class="chart-container" style="height: 200px;">
            <canvas id="activityChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Apply dynamic styles for badge and progress indicator without inline template CSS
    document.addEventListener('DOMContentLoaded', () => {
        const badge = document.getElementById('visualStateBadge');
        if (badge && badge.dataset.color) {
            badge.style.backgroundColor = badge.dataset.color;
        }
        const indicator = document.getElementById('visualProgressIndicator');
        if (indicator && indicator.dataset.left !== undefined) {
            const val = Math.max(0, Math.min(100, parseFloat(indicator.dataset.left)));
            indicator.style.left = `${val}%`;
            indicator.style.transform = 'translate(-50%, -50%)';
        }
        const valueEl = document.getElementById('visualProgressValue');
        if (valueEl && valueEl.dataset.value !== undefined) {
            const v = Math.max(0, Math.min(100, parseFloat(valueEl.dataset.value)));
            valueEl.textContent = `${v}%`;
            valueEl.style.left = `${v}%`;
            valueEl.style.transform = 'translateX(-50%)';
        }
    });

    const ctx = document.getElementById('activityChart').getContext('2d');
    const chartLabels = JSON.parse('{{ chart_labels|safe|escapejs }}');
    const chartData = JSON.parse('{{ chart_data|safe|escapejs }}');
    const breaksChartData = JSON.parse('{{ breaks_chart_data|safe|escapejs }}');
    
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartLabels,
            datasets: [
                {
                    label: 'Parpadeos/min',
                    data: chartData,
                    borderColor: '#A8B5A8',
                    backgroundColor: 'rgba(168, 181, 168, 0.1)',
                    tension: 0,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#A8B5A8',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 6,
                    borderWidth: 2.5
                },
                {
                    label: 'Descansos',
                    data: breaksChartData,
                    borderColor: '#E89F5F',
                    backgroundColor: 'rgba(232, 159, 95, 0.1)',
                    tension: 0,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#E89F5F',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 6,
                    borderWidth: 2.5
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 10,
                    cornerRadius: 8,
                    titleFont: {
                        size: 13
                    },
                    bodyFont: {
                        size: 12
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 18,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.06)',
                        drawBorder: false,
                        lineWidth: 1
                    },
                    ticks: {
                        stepSize: 2,
                        color: '#9CA3AF',
                        font: {
                            size: 11
                        },
                        padding: 6
                    }
                },
                x: {
                    grid: {
                        display: false,
                        drawBorder: false
                    },
                    ticks: {
                        color: '#9CA3AF',
                        font: {
                            size: 11
                        },
                        padding: 6,
                        maxRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 12
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
</script>
{% endblock %}